<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/frontend/lib/screens/main_app_screen.dart">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/frontend/lib/screens/main_app_screen.dart" />
              <option name="originalContent" value="/// File: main_app_screen.dart&#10;/// Mô tả: Widget container chính quản lý các tab và bottom bar, giao diện tiếng Việt.&#10;&#10;import 'package:flutter/material.dart';&#10;import 'package:easy_localization/easy_localization.dart';&#10;import 'home_page.dart';&#10;import 'messages_screen.dart';&#10;import '../widgets/custom_bottom_nav_bar.dart';&#10;import '../models/destination.dart';&#10;import 'destination_detail_screen.dart';&#10;import 'destination_explore_screen.dart';&#10;import 'before_group_screen.dart';&#10;import 'group_creating.dart';&#10;import 'destination_search_screen.dart';&#10;import 'settings_screen.dart';&#10;import 'notification_screen.dart';&#10;import 'profile.dart';&#10;import 'join_group_screen.dart';&#10;import 'group_state_screen.dart';&#10;import 'travel_plan_screen.dart';&#10;import 'personal_section.dart';&#10;&#10;class MainAppScreen extends StatefulWidget {&#10;  final int initialIndex;&#10;  final String accessToken;&#10;&#10;  const MainAppScreen({&#10;    Key? key,&#10;    this.initialIndex = 0,&#10;    required this.accessToken,&#10;  }) : super(key: key);&#10;&#10;  @override&#10;  State&lt;MainAppScreen&gt; createState() =&gt; _MainAppScreenState();&#10;}&#10;&#10;class _MainAppScreenState extends State&lt;MainAppScreen&gt; {&#10;  late int _selectedIndex;&#10;  Destination? _selectedDestination;&#10;  bool _showDetail = false;&#10;  bool _showExplore = false;&#10;  bool _showBeforeGroup = false;&#10;  bool _showGroupCreating = false;&#10;  bool _showSettings = false;&#10;  bool _showProfile = false;&#10;  bool _showJoinGroup = false;&#10;  bool _showGroupState = false;&#10;  bool _showTravelPlan = false;&#10;  bool _showPersonal = false;&#10;  String? _groupDestinationName;&#10;&#10;  @override&#10;  void initState() {&#10;    super.initState();&#10;    _selectedIndex = widget.initialIndex;&#10;  }&#10;&#10;  void _onItemTapped(int index) {&#10;    setState(() {&#10;      _selectedIndex = index;&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;      _showProfile = false;&#10;    });&#10;  }&#10;&#10;  void _openDestinationDetail(Destination dest) {&#10;    setState(() {&#10;      _selectedDestination = dest;&#10;      _showDetail = true;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;    });&#10;  }&#10;&#10;  void _openDestinationExplore() {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = true;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;    });&#10;  }&#10;&#10;  void _openBeforeGroup() {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = true;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;    });&#10;  }&#10;&#10;  void _openGroupCreating(String? destinationName) {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = true;&#10;      _showSettings = false;&#10;      _showProfile = false;&#10;      _groupDestinationName = destinationName;&#10;    });&#10;  }&#10;&#10;  void _closeAllScreens() {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;      _showProfile = false;&#10;    });&#10;  }&#10;&#10;  void _openSettings() {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = true;&#10;      _showProfile = false;&#10;    });&#10;  }&#10;&#10;  void _openProfile() {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;      _showProfile = true;&#10;    });&#10;  }&#10;&#10;  void _openDestinationSearchScreen() {&#10;    if (_selectedDestination != null) {&#10;      Navigator.of(context).push(&#10;        MaterialPageRoute(&#10;          builder: (context) =&gt; DestinationSearchScreen(cityId: _selectedDestination!.cityId),&#10;        ),&#10;      );&#10;    }&#10;  }&#10;&#10;  // Xử lý nút back của điện thoại&#10;  Future&lt;bool&gt; _handleBackButton() async {&#10;    // Nếu đang ở màn hình phụ (Settings, Detail, Explore, BeforeGroup, GroupCreating, Profile)&#10;    if (_showSettings || _showDetail || _showExplore || _showBeforeGroup || _showGroupCreating || _showProfile) {&#10;      // Nếu đang ở Profile, quay về Settings&#10;      if (_showProfile) {&#10;        _openSettings();&#10;        return false;&#10;      }&#10;      // Nếu đang ở GroupCreating, quay về BeforeGroup&#10;      if (_showGroupCreating) {&#10;        _openBeforeGroup();&#10;        return false;&#10;      }&#10;      // Các trường hợp khác, đóng tất cả&#10;      _closeAllScreens();&#10;      return false; // Không thoát app&#10;    }&#10;&#10;    // Nếu đang ở tab khác ngoài Home (tab 0)&#10;    if (_selectedIndex != 0) {&#10;      setState(() {&#10;        _selectedIndex = 0; // Quay về tab Home&#10;      });&#10;      return false; // Không thoát app&#10;    }&#10;&#10;    // Nếu đang ở tab Home → Hiển thị dialog xác nhận thoát&#10;    final shouldExit = await showDialog&lt;bool&gt;(&#10;      context: context,&#10;      builder: (context) =&gt; AlertDialog(&#10;        title: Text('exit_app'.tr()),&#10;        content: Text('exit_app_confirmation'.tr()),&#10;        actions: [&#10;          TextButton(&#10;            onPressed: () =&gt; Navigator.of(context).pop(false),&#10;            child: Text('cancel'.tr()),&#10;          ),&#10;          TextButton(&#10;            onPressed: () =&gt; Navigator.of(context).pop(true),&#10;            child: Text('exit'.tr()),&#10;          ),&#10;        ],&#10;      ),&#10;    );&#10;&#10;    return shouldExit ?? false; // Chỉ thoát khi user chọn &quot;Thoát&quot;&#10;  }&#10;&#10;  @override&#10;  Widget build(BuildContext context) {&#10;    Widget mainContent;&#10;    if (_showProfile) {&#10;      mainContent = ProfilePage(onBack: _openSettings);&#10;    } else if (_showSettings) {&#10;      mainContent = SettingsScreen(onBack: _closeAllScreens, onProfileTap: _openProfile);&#10;    } else if (_showGroupCreating) {&#10;      mainContent = GroupCreatingScreen(&#10;        destinationName: _groupDestinationName,&#10;        onBack: _openBeforeGroup,&#10;      );&#10;    } else if (_showBeforeGroup) {&#10;      mainContent = BeforeGroup(&#10;        onBack: _closeAllScreens,&#10;        onCreateGroup: _openGroupCreating,&#10;      );&#10;    } else if (_showDetail &amp;&amp; _selectedDestination != null) {&#10;      mainContent = DestinationDetailScreen(&#10;        destination: _selectedDestination,&#10;        onBack: _closeAllScreens,&#10;        onContinue: _openDestinationExplore,&#10;      );&#10;    } else if (_showExplore &amp;&amp; _selectedDestination != null) {&#10;      mainContent = DestinationExploreScreen(&#10;        cityId: _selectedDestination!.cityId,&#10;        currentIndex: _selectedIndex,&#10;        onTabChange: _onItemTapped,&#10;        onBack: _closeAllScreens,&#10;        onBeforeGroup: _openBeforeGroup,&#10;        onSearchPlace: _openDestinationSearchScreen,&#10;      );&#10;    } else {&#10;      final List&lt;Widget&gt; _screens = [&#10;        HomePage(&#10;          onDestinationTap: _openDestinationDetail,&#10;          onSettingsTap: _openSettings,&#10;        ),&#10;        NotificationScreen(),&#10;        MessagesScreen(accessToken: widget.accessToken),&#10;        const PrivateScreen(),&#10;      ];&#10;      mainContent = IndexedStack(&#10;        index: _selectedIndex,&#10;        children: _screens,&#10;      );&#10;    }&#10;&#10;    return PopScope(&#10;      canPop: false,&#10;      onPopInvokedWithResult: (bool didPop, dynamic result) async {&#10;        if (!didPop) {&#10;          final shouldPop = await _handleBackButton();&#10;          if (shouldPop &amp;&amp; mounted) {&#10;            Navigator.of(context).pop();&#10;          }&#10;        }&#10;      },&#10;      child: Scaffold(&#10;        extendBody: true, // Cho phép body kéo dài xuống dưới bottom bar&#10;        body: mainContent,&#10;        bottomNavigationBar: CustomBottomNavBar(&#10;          currentIndex: _selectedIndex,&#10;          onTap: _onItemTapped,&#10;        ),&#10;      ),&#10;    );&#10;  }&#10;}&#10;" />
              <option name="updatedContent" value="/// File: main_app_screen.dart&#10;/// Mô tả: Widget container chính quản lý các tab và bottom bar, giao diện tiếng Việt.&#10;&#10;import 'package:flutter/material.dart';&#10;import 'package:easy_localization/easy_localization.dart';&#10;import 'home_page.dart';&#10;import 'messages_screen.dart';&#10;import '../widgets/custom_bottom_nav_bar.dart';&#10;import '../models/destination.dart';&#10;import 'destination_detail_screen.dart';&#10;import 'destination_explore_screen.dart';&#10;import 'before_group_screen.dart';&#10;import 'group_creating.dart';&#10;import 'destination_search_screen.dart';&#10;import 'settings_screen.dart';&#10;import 'notification_screen.dart';&#10;import 'profile.dart';&#10;import 'join_group_screen.dart';&#10;import 'group_state_screen.dart';&#10;import 'travel_plan_screen.dart';&#10;import 'personal_section.dart';&#10;&#10;class MainAppScreen extends StatefulWidget {&#10;  final int initialIndex;&#10;  final String accessToken;&#10;&#10;  const MainAppScreen({&#10;    Key? key,&#10;    this.initialIndex = 0,&#10;    required this.accessToken,&#10;  }) : super(key: key);&#10;&#10;  @override&#10;  State&lt;MainAppScreen&gt; createState() =&gt; _MainAppScreenState();&#10;}&#10;&#10;class _MainAppScreenState extends State&lt;MainAppScreen&gt; {&#10;  late int _selectedIndex;&#10;  Destination? _selectedDestination;&#10;  bool _showDetail = false;&#10;  bool _showExplore = false;&#10;  bool _showBeforeGroup = false;&#10;  bool _showGroupCreating = false;&#10;  bool _showSettings = false;&#10;  bool _showProfile = false;&#10;  bool _showJoinGroup = false;&#10;  bool _showGroupState = false;&#10;  bool _showTravelPlan = false;&#10;  bool _showPersonal = false;&#10;  String? _groupDestinationName;&#10;&#10;  @override&#10;  void initState() {&#10;    super.initState();&#10;    _selectedIndex = widget.initialIndex;&#10;  }&#10;&#10;  void _onItemTapped(int index) {&#10;    setState(() {&#10;      _selectedIndex = index;&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;      _showProfile = false;&#10;      _showJoinGroup = false;&#10;      _showGroupState = false;&#10;      _showTravelPlan = false;&#10;    });&#10;  }&#10;&#10;  void _openDestinationDetail(Destination dest) {&#10;    setState(() {&#10;      _selectedDestination = dest;&#10;      _showDetail = true;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;      _selectedIndex = -1;&#10;    });&#10;  }&#10;&#10;  void _openDestinationExplore() {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = true;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;    });&#10;  }&#10;&#10;  void _openBeforeGroup() {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = true;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;    });&#10;  }&#10;&#10;  void _openGroupCreating(String? destinationName) {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = true;&#10;      _showSettings = false;&#10;      _showProfile = false;&#10;      _groupDestinationName = destinationName;&#10;    });&#10;  }&#10;&#10;  void _closeAllScreens() {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;      _showProfile = false;&#10;    });&#10;  }&#10;&#10;  void _openSettings() {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = true;&#10;      _showProfile = false;&#10;    });&#10;  }&#10;&#10;  void _openProfile() {&#10;    setState(() {&#10;      _showDetail = false;&#10;      _showExplore = false;&#10;      _showBeforeGroup = false;&#10;      _showGroupCreating = false;&#10;      _showSettings = false;&#10;      _showProfile = true;&#10;    });&#10;  }&#10;&#10;  void _openDestinationSearchScreen() {&#10;    if (_selectedDestination != null) {&#10;      Navigator.of(context).push(&#10;        MaterialPageRoute(&#10;          builder: (context) =&gt; DestinationSearchScreen(cityId: _selectedDestination!.cityId),&#10;        ),&#10;      );&#10;    }&#10;  }&#10;&#10;  // Xử lý nút back của điện thoại&#10;  Future&lt;bool&gt; _handleBackButton() async {&#10;    // Nếu đang ở màn hình phụ (Settings, Detail, Explore, BeforeGroup, GroupCreating, Profile)&#10;    if (_showSettings || _showDetail || _showExplore || _showBeforeGroup || _showGroupCreating || _showProfile) {&#10;      // Nếu đang ở Profile, quay về Settings&#10;      if (_showProfile) {&#10;        _openSettings();&#10;        return false;&#10;      }&#10;      // Nếu đang ở GroupCreating, quay về BeforeGroup&#10;      if (_showGroupCreating) {&#10;        _openBeforeGroup();&#10;        return false;&#10;      }&#10;      // Các trường hợp khác, đóng tất cả&#10;      _closeAllScreens();&#10;      return false; // Không thoát app&#10;    }&#10;&#10;    // Nếu đang ở tab khác ngoài Home (tab 0)&#10;    if (_selectedIndex != 0) {&#10;      setState(() {&#10;        _selectedIndex = 0; // Quay về tab Home&#10;      });&#10;      return false; // Không thoát app&#10;    }&#10;&#10;    // Nếu đang ở tab Home → Hiển thị dialog xác nhận thoát&#10;    final shouldExit = await showDialog&lt;bool&gt;(&#10;      context: context,&#10;      builder: (context) =&gt; AlertDialog(&#10;        title: Text('exit_app'.tr()),&#10;        content: Text('exit_app_confirmation'.tr()),&#10;        actions: [&#10;          TextButton(&#10;            onPressed: () =&gt; Navigator.of(context).pop(false),&#10;            child: Text('cancel'.tr()),&#10;          ),&#10;          TextButton(&#10;            onPressed: () =&gt; Navigator.of(context).pop(true),&#10;            child: Text('exit'.tr()),&#10;          ),&#10;        ],&#10;      ),&#10;    );&#10;&#10;    return shouldExit ?? false; // Chỉ thoát khi user chọn &quot;Thoát&quot;&#10;  }&#10;&#10;  @override&#10;  Widget build(BuildContext context) {&#10;    Widget mainContent;&#10;    if (_showProfile) {&#10;      mainContent = ProfilePage(onBack: _openSettings);&#10;    } else if (_showSettings) {&#10;      mainContent = SettingsScreen(onBack: _closeAllScreens, onProfileTap: _openProfile);&#10;    } else if (_showGroupCreating) {&#10;      mainContent = GroupCreatingScreen(&#10;        destinationName: _groupDestinationName,&#10;        onBack: _openBeforeGroup,&#10;      );&#10;    } else if (_showBeforeGroup) {&#10;      mainContent = BeforeGroup(&#10;        onBack: _closeAllScreens,&#10;        onCreateGroup: _openGroupCreating,&#10;      );&#10;    } else if (_showDetail &amp;&amp; _selectedDestination != null) {&#10;      mainContent = DestinationDetailScreen(&#10;        destination: _selectedDestination,&#10;        onBack: _closeAllScreens,&#10;        onContinue: _openDestinationExplore,&#10;      );&#10;    } else if (_showExplore &amp;&amp; _selectedDestination != null) {&#10;      mainContent = DestinationExploreScreen(&#10;        cityId: _selectedDestination!.cityId,&#10;        currentIndex: _selectedIndex,&#10;        onTabChange: _onItemTapped,&#10;        onBack: _closeAllScreens,&#10;        onBeforeGroup: _openBeforeGroup,&#10;        onSearchPlace: _openDestinationSearchScreen,&#10;      );&#10;    } else {&#10;      final List&lt;Widget&gt; _screens = [&#10;        HomePage(&#10;          onDestinationTap: _openDestinationDetail,&#10;          onSettingsTap: _openSettings,&#10;        ),&#10;        NotificationScreen(),&#10;        MessagesScreen(accessToken: widget.accessToken),&#10;        const PrivateScreen(),&#10;      ];&#10;      mainContent = IndexedStack(&#10;        index: _selectedIndex,&#10;        children: _screens,&#10;      );&#10;    }&#10;&#10;    return PopScope(&#10;      canPop: false,&#10;      onPopInvokedWithResult: (bool didPop, dynamic result) async {&#10;        if (!didPop) {&#10;          final shouldPop = await _handleBackButton();&#10;          if (shouldPop &amp;&amp; mounted) {&#10;            Navigator.of(context).pop();&#10;          }&#10;        }&#10;      },&#10;      child: Scaffold(&#10;        extendBody: true, // Cho phép body kéo dài xuống dưới bottom bar&#10;        body: mainContent,&#10;        bottomNavigationBar: CustomBottomNavBar(&#10;          currentIndex: _selectedIndex,&#10;          onTap: _onItemTapped,&#10;        ),&#10;      ),&#10;    );&#10;  }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>